<!-- SCRIPT BAGIAN 1 -->
<script>
// Inisialisasi tanggal default
const dateInput = document.getElementById("dateInput");
dateInput.value = new Date().toISOString().slice(0,10);

// Data members dan transaksi
let members = JSON.parse(localStorage.getItem("members")) || [];
let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
transactions = transactions.map(t => ({
  ...t,
  amount: Number(t.amount)||0,
  edited: t.edited||false,
  editHistory: t.editHistory || []
}));

const memberSelect = document.getElementById("memberSelect");
const filterMember = document.getElementById("filterMember");
const amountInput = document.getElementById("amountInput");
const btnDeleteSelected = document.getElementById("btnDeleteSelected");

// Format input angka
amountInput.addEventListener("input", function(e){
  let cursorPos = this.selectionStart;
  let value = this.value.replace(/\D/g,'');
  this.value = value? Number(value).toLocaleString("id-ID"):"";
  this.setSelectionRange(cursorPos,cursorPos);
});

// Render daftar members
function renderMembers(){
  memberSelect.innerHTML="";
  memberSelect.innerHTML+=`<option value="" disabled selected>Pilih anggota</option>`;
  members.forEach(m=>{
    memberSelect.innerHTML+=`<option value="${m}">${m}</option>`;
  });
  memberSelect.innerHTML+=`<option value="+">+ Tambah Anggota</option>`;
  memberSelect.innerHTML+=`<option value="-">- Hapus Anggota</option>`;

  const editMember = document.getElementById("editMember");
  if(editMember){
    editMember.innerHTML="";
    members.forEach(m=>{editMember.innerHTML+=`<option value="${m}">${m}</option>`});
  }

  filterMember.innerHTML='<option value="all">Semua Anggota</option>';
  members.forEach(m=>{
    filterMember.innerHTML+=`<option value="${m}">${m}</option>`;
  });
}

// Tambah / hapus anggota
function memberOptionChange(){
  const val = memberSelect.value;
  if(val === "+"){
    const name = prompt("Masukkan nama anggota baru:").trim();
    if(name && !members.includes(name)) members.push(name);
    saveData(); renderMembers();
  } else if(val === "-"){
    if(members.length===0){ alert("Tidak ada anggota tersisa!"); return; }
    const name = prompt("Pilih anggota untuk dihapus:\n"+members.join("\n"));
    if(name && members.includes(name)){
      members = members.filter(m=>m!==name);
      saveData(); renderMembers();
    }
  }
}

// Simpan data ke localStorage
function saveData(){ 
  localStorage.setItem("transactions", JSON.stringify(transactions));
  localStorage.setItem("members", JSON.stringify(members));
}

// Format rupiah
function formatRupiah(angka){ return "Rp "+angka.toLocaleString("id-ID"); }
function parseRupiah(str){ return Number(str.replace(/[^0-9]/g,""))||0; }

// Render chart pemasukan & pengeluaran
function renderChart(){
  const incomeTotal = transactions.filter(t=>t.type==="pemasukan").reduce((a,b)=>a+b.amount,0);
  const expenseTotal = transactions.filter(t=>t.type==="pengeluaran").reduce((a,b)=>a+b.amount,0);
  const total = incomeTotal + expenseTotal || 1;
  document.querySelector(".incomeBar").style.width = (incomeTotal/total*100)+"%";
  document.querySelector(".expenseBar").style.width = (expenseTotal/total*100)+"%";
}

// Update tombol delete terpilih
function updateDeleteSelectedButton(){
  const anyChecked = document.querySelectorAll(".rowCheckbox:checked").length>0;
  btnDeleteSelected.style.display = anyChecked?"inline-block":"none";
}

// Inisialisasi awal
renderMembers();
renderChart();
</script>
<!-- SCRIPT BAGIAN 2 -->
<script>

// Tambahkan div global untuk tooltip
let tooltipDiv = document.createElement("div");
tooltipDiv.id = "editTooltip";
tooltipDiv.style.position = "absolute";
tooltipDiv.style.background = "#fff";
tooltipDiv.style.border = "1px solid #ccc";
tooltipDiv.style.padding = "10px";
tooltipDiv.style.borderRadius = "6px";
tooltipDiv.style.boxShadow = "0 3px 8px rgba(0,0,0,0.2)";
tooltipDiv.style.display = "none";
tooltipDiv.style.zIndex = 1001;
tooltipDiv.style.maxWidth = "300px";
tooltipDiv.style.fontSize = "0.9em";
tooltipDiv.style.pointerEvents = "auto";
tooltipDiv.style.opacity = 0;
tooltipDiv.style.transition = "opacity 0.3s";
tooltipDiv.style.cursor = "default";
document.body.appendChild(tooltipDiv);
tooltipDiv.innerHTML = ""; 

// Tutup tooltip saat klik di luar
document.addEventListener("click", function(e){
  if(!tooltipDiv.contains(e.target) && !e.target.classList.contains("statusCell")){
    tooltipDiv.style.opacity = 0;
    setTimeout(()=>{ tooltipDiv.style.display = "none"; },300);
  }
});

// Render tabel lengkap dengan tooltip
function renderTable(filtered=[]){
  const table = document.getElementById("transactionTable");
  table.innerHTML="";
  let totalIncome=0, totalExpense=0;
  const data = filtered.length?filtered:transactions;
  data.forEach((t,i)=>{
    if(t.type==="pemasukan") totalIncome+=t.amount;
    else totalExpense+=t.amount;

    let tooltipContent = t.editHistory.map(h=>`${h.date}: ${h.changes.join("; ")}`).join("<br>");

    table.innerHTML+=`<tr>
      <td><input type="checkbox" class="rowCheckbox" data-index="${i}" onchange="updateDeleteSelectedButton()"></td>
      <td>${i+1}</td>
      <td>${t.date}</td>
      <td>${t.desc}</td>
      <td>${t.member||""}</td>
      <td>${t.source||""}</td>
      <td>${t.type==="pemasukan"?formatRupiah(t.amount):""}</td>
      <td>${t.type==="pengeluaran"?formatRupiah(t.amount):""}</td>
      <td class="statusCell" data-tooltip='${tooltipContent}'>${t.edited?"(diedit)":""}</td>
      <td><button class="aksi-btn" onclick="openEditModal(${i})">✏️</button></td>
    </tr>`;
  });
  document.getElementById("totalIncome").innerText=formatRupiah(totalIncome);
  document.getElementById("totalExpense").innerText=formatRupiah(totalExpense);
  document.getElementById("balance").innerText=formatRupiah(totalIncome-totalExpense);
  renderChart();
  updateDeleteSelectedButton();
}

// Tambah transaksi
function addTransaction(){
  const date = dateInput.value;
  const desc = document.getElementById("descInput").value;
  const amount = parseRupiah(document.getElementById("amountInput").value);
  const member = memberSelect.value;
  const source = document.getElementById("sourceInput").value;
  const type = document.getElementById("typeInput").value;
  if(!desc || amount<=0){ alert("Isi semua field dengan benar!"); return; }
  transactions.push({
    date,desc,amount,type,
    member:(member==="+"||member==="-")?"":member,
    source,edited:false,editHistory:[]
  });
  saveData(); renderTable();
  document.getElementById("descInput").value="";
  document.getElementById("amountInput").value="";
  document.getElementById("sourceInput").value="";
  document.getElementById("typeInput").value="pemasukan";
  memberSelect.value="";
}

// Hapus transaksi terpilih
function deleteSelected(){
  const checked = document.querySelectorAll(".rowCheckbox:checked");
  if(checked.length===0){ alert("Tidak ada transaksi terpilih!"); return; }
  if(confirm(`Hapus ${checked.length} transaksi terpilih?`)){
    const indexes = Array.from(checked).map(c=>Number(c.dataset.index)).sort((a,b)=>b-a);
    indexes.forEach(i=>transactions.splice(i,1));
    saveData(); renderTable();
    document.getElementById("selectAll").checked=false;
  }
}

// Toggle select all
function toggleSelectAll(cb){
  document.querySelectorAll(".rowCheckbox").forEach(c=>c.checked=cb.checked);
  updateDeleteSelectedButton();
}

// Modal edit
function openEditModal(i){
  const t = transactions[i];
  const modal = document.getElementById("editModal");
  modal.style.display="block";
  document.getElementById("editDate").value=t.date;
  document.getElementById("editDesc").value=t.desc;
  document.getElementById("editAmount").value=t.amount.toLocaleString("id-ID");
  document.getElementById("editMember").value=t.member||"";
  document.getElementById("editSource").value=t.source||"";
  document.getElementById("editType").value=t.type;
  modal.dataset.index=i;
}

function closeModal(){ document.getElementById("editModal").style.display="none"; }

// Simpan edit dengan riwayat
function saveEdit(){
  const i = Number(document.getElementById("editModal").dataset.index);
  const t = transactions[i];
  let changes = [];

  if(t.date !== document.getElementById("editDate").value){
    changes.push(`Tanggal: ${t.date} → ${document.getElementById("editDate").value}`);
    t.date = document.getElementById("editDate").value;
  }
  if(t.desc !== document.getElementById("editDesc").value){
    changes.push(`Deskripsi: ${t.desc} → ${document.getElementById("editDesc").value}`);
    t.desc = document.getElementById("editDesc").value;
  }
  let newAmount = parseRupiah(document.getElementById("editAmount").value);
  if(t.amount !== newAmount){
    changes.push(`Jumlah: ${formatRupiah(t.amount)} → ${formatRupiah(newAmount)}`);
    t.amount = newAmount;
  }
  if(t.member !== document.getElementById("editMember").value){
    changes.push(`Anggota: ${t.member} → ${document.getElementById("editMember").value}`);
    t.member = document.getElementById("editMember").value;
  }
  if(t.source !== document.getElementById("editSource").value){
    changes.push(`Sumber: ${t.source} → ${document.getElementById("editSource").value}`);
    t.source = document.getElementById("editSource").value;
  }
  if(t.type !== document.getElementById("editType").value){
    changes.push(`Tipe: ${t.type} → ${document.getElementById("editType").value}`);
    t.type = document.getElementById("editType").value;
  }

  if(changes.length){
    t.edited = true;
    t.editHistory.push({
      date: new Date().toLocaleString("id-ID"),
      changes
    });
  }

  saveData(); renderTable(); closeModal();
}

// Filter transaksi
function applyFilter(){
  let fMember = filterMember.value;
  let fType = document.getElementById("filterType").value;
  let filtered = transactions.filter(t=>{
    return (fMember==="all" || t.member===fMember) && (fType==="all" || t.type===fType);
  });
  renderTable(filtered);
}

// Export CSV
function exportExcel(){
  let csv="Tanggal,Deskripsi,Anggota,Sumber Dana,Pemasukan,Pengeluaran\n";
  transactions.forEach(t=>{
    csv+=`${t.date},${t.desc},${t.member||""},${t.source||""},${t.type==="pemasukan"?t.amount:""},${t.type==="pengeluaran"?t.amount:""}\n`;
  });
  let blob = new Blob([csv], { type: "text/csv" });
  let url = window.URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "laporan_keuangan.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Inisialisasi render awal
renderMembers();
renderTable();

</script>
<!-- SCRIPT BAGIAN 3: Tooltip Panah Otomatis Responsive -->
<script>

// Ganti event tooltip lama dengan versi panah otomatis
document.querySelectorAll(".statusCell").forEach(cell=>{
  cell.addEventListener("click", e=>{
    const content = cell.dataset.tooltip;
    if(!content) return;
    tooltipDiv.innerHTML = content;

    tooltipDiv.style.display = "block";
    tooltipDiv.style.opacity = 0;

    const rect = cell.getBoundingClientRect();
    const scrollX = window.scrollX || window.pageXOffset;
    const scrollY = window.scrollY || window.pageYOffset;
    const tooltipWidth = tooltipDiv.offsetWidth;
    const tooltipHeight = tooltipDiv.offsetHeight;
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    let left, top;
    let arrowDirection = "top"; // default panah di atas

    // Tentukan posisi horizontal
    if(rect.right + tooltipWidth + 10 < viewportWidth){
      left = rect.right + 10 + scrollX;
      arrowDirection = "left";
    } else if(rect.left - tooltipWidth - 10 > 0){
      left = rect.left - tooltipWidth - 10 + scrollX;
      arrowDirection = "right";
    } else { 
      // fallback posisi bawah
      left = rect.left + scrollX;
      arrowDirection = "top";
    }

    // Tentukan posisi vertikal
    if(rect.top + tooltipHeight > viewportHeight){
      top = rect.bottom - tooltipHeight + scrollY; // geser ke atas
    } else {
      top = rect.top + scrollY;
    }

    tooltipDiv.style.left = left + "px";
    tooltipDiv.style.top = top + "px";

    // Set panah otomatis
    let arrowStyle = "";
    switch(arrowDirection){
      case "left":
        arrowStyle = "position:absolute; left:-6px; top:10px; border-top:6px solid transparent; border-bottom:6px solid transparent; border-right:6px solid #fff;";
        break;
      case "right":
        arrowStyle = "position:absolute; right:-6px; top:10px; border-top:6px solid transparent; border-bottom:6px solid transparent; border-left:6px solid #fff;";
        break;
      case "top":
        arrowStyle = "position:absolute; top:-6px; left:10px; border-left:6px solid transparent; border-right:6px solid transparent; border-bottom:6px solid #fff;";
        break;
    }

    tooltipDiv.style.setProperty('--arrow-style', arrowStyle);

    // Buat panah div
    let arrowDiv = tooltipDiv.querySelector(".tooltipArrow");
    if(!arrowDiv){
      arrowDiv = document.createElement("div");
      arrowDiv.className = "tooltipArrow";
      tooltipDiv.appendChild(arrowDiv);
    }
    arrowDiv.style.cssText = arrowStyle;

    setTimeout(()=>{ tooltipDiv.style.opacity = 1; },10);
    e.stopPropagation();
  });
});

// Tutup tooltip saat klik di luar (tetap sama)
document.addEventListener("click", function(e){
  if(!tooltipDiv.contains(e.target) && !e.target.classList.contains("statusCell")){
    tooltipDiv.style.opacity = 0;
    setTimeout(()=>{ tooltipDiv.style.display = "none"; },300);
  }
});

</script>
