<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Laporan Keuangan Modern</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body.dark-mode {
      background-color: #121212;
      color: #eaeaea;
    }
    body.dark-mode .card {
      background-color: #1e1e1e;
      color: #eaeaea;
    }
    body.dark-mode .table {
      color: #eaeaea;
    }
    body.dark-mode .table-dark {
      background-color: #333 !important;
    }
    .mode-toggle {
      position: fixed;
      top: 15px;
      right: 20px;
      z-index: 1000;
    }
  </style>
</head>
<body class="bg-light">

<!-- Toggle Dark/Light -->
<div class="mode-toggle form-check form-switch">
  <input class="form-check-input" type="checkbox" id="modeSwitch" onchange="toggleMode()">
  <label class="form-check-label" for="modeSwitch">ðŸŒ™</label>
</div>

<div class="container py-4">
  <h1 class="text-center mb-4">ðŸ“Š Aplikasi Laporan Keuangan</h1>

  <!-- Input Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-2"><input type="date" id="date" class="form-control"></div>
        <div class="col-md-3"><input type="text" id="desc" class="form-control" placeholder="Keterangan"></div>
        <div class="col-md-2"><input type="number" id="amount" class="form-control" placeholder="Jumlah (Rp)"></div>
        <div class="col-md-2">
          <select id="type" class="form-select">
            <option value="Pemasukan">Pemasukan</option>
            <option value="Pengeluaran">Pengeluaran</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" onclick="addTransaction()">Tambah Transaksi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-md-2 fw-bold">Filter Periode:</div>
        <div class="col-md-3"><input type="date" id="startDate" class="form-control"></div>
        <div class="col-md-3"><input type="date" id="endDate" class="form-control"></div>
        <div class="col-md-2"><button class="btn btn-success w-100" onclick="applyFilter()">Terapkan</button></div>
        <div class="col-md-2"><button class="btn btn-secondary w-100" onclick="resetFilter()">Reset</button></div>
      </div>
    </div>
  </div>

  <!-- Report -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h4 class="mb-3">Laporan Keuangan</h4>
      <p id="reportPeriod" class="fw-bold text-primary"></p>

      <div class="table-responsive">
        <table id="transactionTable" class="table table-bordered table-striped align-middle">
          <thead class="table-dark">
            <tr>
              <th>Tanggal</th>
              <th>Keterangan</th>
              <th>Pemasukan (Rp)</th>
              <th>Pengeluaran (Rp)</th>
              <th>Saldo (Rp)</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="summaryPeriod" class="alert alert-info fw-bold mt-3"></div>
    </div>
  </div>

  <!-- Grafik -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5>Grafik Perkembangan Saldo</h5>
      <canvas id="financeChart" height="100"></canvas>
    </div>
  </div>

  <!-- Export -->
  <div class="card shadow-sm">
    <div class="card-body text-center">
      <h5 class="mb-3">Export Laporan</h5>
      <button class="btn btn-outline-success m-1" onclick="exportExcel(false)">Export Semua (Excel)</button>
      <button class="btn btn-success m-1" onclick="exportExcel(true)">Export Filter (Excel)</button>
      <button class="btn btn-outline-danger m-1" onclick="exportPDF(false)">Export Semua (PDF)</button>
      <button class="btn btn-danger m-1" onclick="exportPDF(true)">Export Filter (PDF)</button>
    </div>
  </div>
</div>

<script>
  let transactions = [];
  let filteredTransactions = [];
  let financeChart;

  function addTransaction() {
    let date = document.getElementById("date").value;
    let desc = document.getElementById("desc").value;
    let amount = parseFloat(document.getElementById("amount").value);
    let type = document.getElementById("type").value;

    if (!date || !desc || isNaN(amount)) {
      alert("Lengkapi semua field!");
      return;
    }
    transactions.push({ date, desc, amount, type });
    filteredTransactions = [...transactions];
    renderTable(); renderChart();
  }

  function editTransaction(index) {
    let t = filteredTransactions[index];
    document.getElementById("date").value = t.date;
    document.getElementById("desc").value = t.desc;
    document.getElementById("amount").value = t.amount;
    document.getElementById("type").value = t.type;
    deleteTransaction(index);
  }

  function deleteTransaction(index) {
    let realIndex = transactions.indexOf(filteredTransactions[index]);
    transactions.splice(realIndex, 1);
    filteredTransactions.splice(index, 1);
    renderTable(); renderChart();
  }

  function renderTable() {
    const tbody = document.querySelector("#transactionTable tbody");
    tbody.innerHTML = "";
    let balance = 0, totalIncome = 0, totalExpense = 0;

    let start = document.getElementById("startDate").value;
    let end = document.getElementById("endDate").value;
    let reportPeriod = document.getElementById("reportPeriod");
    reportPeriod.innerText = start && end ? `Periode Laporan: 
