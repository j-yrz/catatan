<script>
  let transactions = JSON.parse(localStorage.getItem("transactions")) || [];

  // pastikan amount jadi angka
  transactions = transactions.map(t => ({
    ...t,
    amount: Number(t.amount) || 0
  }));

  function saveData() {
    localStorage.setItem("transactions", JSON.stringify(transactions));
  }

  function formatRupiah(angka) {
    return "Rp " + angka.toLocaleString("id-ID");
  }

  function renderTable() {
    const table = document.getElementById("transactionTable");
    table.innerHTML = "";
    let totalIncome = 0, totalExpense = 0;

    transactions.forEach((t, i) => {
      if (t.type === "pemasukan") totalIncome += t.amount;
      else totalExpense += t.amount;

      let row = `<tr>
        <td>${t.date}</td>
        <td>${t.desc}</td>
        <td>${t.type === "pemasukan" ? formatRupiah(t.amount) : ""}</td>
        <td>${t.type === "pengeluaran" ? formatRupiah(t.amount) : ""}</td>
        <td>
          <button class="aksi-btn edit" onclick="editTransaction(${i})">âœï¸</button>
          <button class="aksi-btn delete" onclick="deleteTransaction(${i})">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
      table.innerHTML += row;
    });

    // update kotak atas
    document.getElementById("totalIncome").innerText = formatRupiah(totalIncome);
    document.getElementById("totalExpense").innerText = formatRupiah(totalExpense);
    document.getElementById("balance").innerText = formatRupiah(totalIncome - totalExpense);
  }

  function addTransaction() {
    const date = document.getElementById("dateInput").value || new Date().toISOString().slice(0,10);
    const desc = document.getElementById("descInput").value;
    const amount = Number(document.getElementById("amountInput").value);
    const type = document.getElementById("typeInput").value;

    if (!desc || isNaN(amount)) {
      alert("Isi semua field!");
      return;
    }

    transactions.push({date, desc, amount, type});
    saveData();
    renderTable();

    // reset form
    document.getElementById("descInput").value = "";
    document.getElementById("amountInput").value = "";
  }

  function deleteTransaction(i) {
    if (confirm("Yakin mau hapus transaksi ini?")) {
      transactions.splice(i, 1);
      saveData();
      renderTable();
    }
  }

  function editTransaction(i) {
    let t = transactions[i];
    let newDesc = prompt("Edit deskripsi:", t.desc);
    let newAmount = prompt("Edit jumlah:", t.amount);
    if (newDesc !== null && newAmount !== null) {
      transactions[i].desc = newDesc;
      transactions[i].amount = Number(newAmount);
      saveData();
      renderTable();
    }
  }

  function exportExcel() {
    let csv = "Tanggal,Deskripsi,Pemasukan,Pengeluaran\n";
    transactions.forEach(t => {
      csv += `${t.date},${t.desc},${t.type==="pemasukan"?t.amount:""},${t.type==="pengeluaran"?t.amount:""}\n`;
    });

    let blob = new Blob([csv], { type: "text/csv" });
    let url = window.URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "laporan_keuangan.csv";
    a.click();
  }

  // panggil render pas awal load
  renderTable();
</script>
